#########################################
# zplug
# Author: Rui Pinheiro
#
# Initializes and load Zplug and corresponding plugins


###############
# Configuration

# Auto-suggestions
#typeset -g ZSH_AUTOSUGGEST_HIGHLIGHT_STYLE="fg=10"
#typeset -g ZSH_AUTOSUGGEST_BUFFER_MAX_SIZE=20


###############
# Plugins
typeset -g _zplug_loaded=0

function load_plugins {
	if is_false "$1" ; then
		function _zplug {
			local repo="${1%,}"
			local name=$(basename "$repo")

			# Source script from repo
			source "$ZPLUG_ROOT/repos/$repo/$name.plugin.zsh"
		}
	else
		is_true "$_zplug_sourced" && return
		source "$ZPLUG_ROOT/init.zsh"
		function _zplug {
			zplug $@
		}
		_zplug "zplug/zplug"
	fi

	_zplug "zsh-users/zsh-syntax-highlighting", defer:2
	_zplug "zsh-users/zsh-history-substring-search", defer:2
	_zplug "zsh-users/zsh-completions", defer:2
	#_zplug "zsh-users/zsh-autosuggestions"
	#_zplug "rupa/z", use:z.sh # Disabled as it slows down Zsh quite a bit
	
	unfunction _zplug
	if is_true "$1" ; then
		# Install new plugins
		if ! zplug check --verbose; then
			printf "Install? [y/N]: "
			if read -q; then
				echo; zplug install
			fi
		fi

		# Update plugins
		zplug update #--verbose

		# Finalize plugin loading
		zplug load #--verbose

		_zplug_loaded=1
	fi
}

# Load plugins at shell startup
load_plugins 0

# Allow easy lazy-loading of zplug
function zplug {
	echo_info "Lazy-loading 'zplug'..." "zplug"
	unfunction zplug

	load_plugins 1
	zplug $@
}
